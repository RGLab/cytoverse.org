---
title: "clustering gating by kmeans"
author: "mike"
date: "6/26/2020"
output: html_document
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>This document demonstrates how to use <code>openCyto</code> plugin mechanism to incorporate the clustering-based gating algorithm into <code>openCyto</code> auto-gating framework.</p>
<div id="prepare-the-data" class="section level2">
<h2>Prepare the data</h2>
<pre class="r"><code>library(flowCore)
library(flowWorkspace)
dataDir &lt;- system.file(&quot;extdata&quot;,package=&quot;flowWorkspaceData&quot;)
gs &lt;- load_gs(list.files(dataDir, pattern = &quot;gs_manual&quot;,full = TRUE))
#simplify gating tree
gs_pop_remove(gs, &quot;CD4&quot;)
gs_pop_remove(gs, &quot;CD8&quot;)
plot(gs)</code></pre>
<p><img src="docs/examples/openCyto/kmeans_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
<div id="write-a-custom-gating-function-that-runs-kmeans-and-wrap-the-result-as-a-multiplefilterresult" class="section level2">
<h2>Write a custom gating function that runs kmeans and wrap the result as a <code>multipleFilterResult</code></h2>
<pre class="r"><code>kmeans_gating &lt;- function(fr, pp_res = NULL, channels, ...){
    kmeans_results &lt;- kmeans(scale(exprs(fr)[,channels]), ...)
    res &lt;- as.factor(kmeans_results$cluster) 
    #name the sub pops properly
    levels(res) &lt;- paste(&quot;tsub&quot;, levels(res))
    #return it as multipleFilterResult object
    as(res, &quot;filterResult&quot;)
    
}</code></pre>
</div>
<div id="test-it-to-ensure-it-returns-the-expected-result" class="section level2">
<h2>test it to ensure it returns the expected result</h2>
<pre class="r"><code>gh &lt;- gs[[1]]
fr &lt;- gh_pop_get_data(gh, &quot;CD3+&quot;)
markers &lt;- c(&quot;CD4&quot;, &quot;CD8&quot;, &quot;CD45RA&quot;)
channels &lt;- sapply(markers, function(marker){
  getChannelMarker(fr, marker)$name
})

kmeans_gating(fr, channels = channels, centers = 4)</code></pre>
<pre><code>## A filterResult produced by the filter named &#39;&#39;
##  resulting in multiple populations:
##   tsub 1
##   tsub 2
##   tsub 3
##   tsub 4</code></pre>
<p>Note that the <code>levels</code> of the <code>factor</code> will be used to tag the clustering population names.</p>
</div>
<div id="register-it-as-plugin" class="section level2">
<h2>Register it as plugin</h2>
<pre class="r"><code>library(openCyto)
register_plugins(fun = kmeans_gating, methodName = &quot;tsub_gating&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="use-it-in-opencyto-gating" class="section level2">
<h2>Use it in openCyto gating</h2>
<pre class="r"><code>gs_add_gating_method(gs
                     , alias = &quot;*&quot; #* means the pop names are parsed from gating results
                     , pop = &quot;*&quot;
                     , parent = &quot;CD3+&quot;,
                     , dims = &quot;CD4,CD8,CD45RA&quot;, #channels to be passed to gating function
                     , gating_method = &quot;tsub_gating&quot;
                     , gating_args = &quot;centers=4, nstart=5&quot; #arguments passed on to gating function
                     )</code></pre>
</div>
<div id="visualize-the-result" class="section level2">
<h2>Visualize the result</h2>
<pre class="r"><code>plot(gs)</code></pre>
<p><img src="docs/examples/openCyto/kmeans_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<pre class="r"><code>library(ggcyto)
gs_pop_get_stats(gs, node = c(&quot;singlets&quot;, &quot;tsub 1&quot;, &quot;tsub 2&quot;, &quot;tsub 3&quot;, &quot;tsub 4&quot;))</code></pre>
<pre><code>##                     sample      pop count
## 1: CytoTrol_CytoTrol_1.fcs singlets 87022
## 2: CytoTrol_CytoTrol_1.fcs   tsub 1 21958
## 3: CytoTrol_CytoTrol_1.fcs   tsub 2  6607
## 4: CytoTrol_CytoTrol_1.fcs   tsub 3 11562
## 5: CytoTrol_CytoTrol_1.fcs   tsub 4 14356</code></pre>
<pre class="r"><code>ggcyto(gs, aes(CD45RA, CD4), subset = &quot;CD3+&quot;) + 
    geom_gate(&quot;tsub 1&quot;, color = &quot;red&quot;, alpha = 0.5) + 
    geom_gate(&quot;tsub 2&quot;, color = &quot;blue&quot;, alpha = 0.5) + 
    geom_gate(&quot;tsub 3&quot;, color = &quot;black&quot;, alpha = 0.5) +
    geom_gate(&quot;tsub 4&quot;, color = &quot;green&quot;, alpha = 0.5)</code></pre>
<p><img src="docs/examples/openCyto/kmeans_files/figure-html/unnamed-chunk-6-2.png" width="672" /></p>
</div>
