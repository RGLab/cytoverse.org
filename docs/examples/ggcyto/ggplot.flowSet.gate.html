---
title: "Visualize gates on cytometry data with ggplot2"
author: "Mike Jiang"
output:
  html_document:
    keep_md: yes
vignette: >    
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Visualize gates on cytometry data with ggplot2}        
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p><code>ggcyto</code> makes <code>ggplot2</code> to be able to work with <code>Cytometry</code> data, namely <code>flowSet/ncdfFlowSet</code> or <code>flowFrame</code> S4 objects.</p>
<pre class="r"><code>library(ggcyto)
data(GvHD)
fs &lt;- GvHD[subset(pData(GvHD), Patient %in%5:7 &amp; Visit %in% c(5:6))[[&quot;name&quot;]]]
fr &lt;- fs[[1]]</code></pre>
<pre class="r"><code># get a lymphGate
lg &lt;- flowStats::lymphGate(fr, channels=c(&quot;FSC-H&quot;, &quot;SSC-H&quot;),scale=0.6)
p &lt;- ggplot(fr, aes(x = `FSC-H`, y =  `SSC-H`))
p &lt;- p + stat_binhex(bins = 64) + ylim(c(10,9e2)) + xlim(c(10,9e2))   

# add polygonGate layer
p1 &lt;- p + geom_path(data = lg, colour = &quot;red&quot;)#can&#39;t use geom_gate since it is specialized layer to be used with ggcyto wrapper
p1</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code># add rectangleGate layer (2d)
rect.g &lt;- rectangleGate(list(&quot;FSC-H&quot; =  c(300,500), &quot;SSC-H&quot; = c(50,200)))
p1 &lt;- p1 + geom_polygon(data = rect.g, colour = &quot;red&quot;, fill = &quot;transparent&quot;)
p1</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-2.png" width="672" /></p>
<pre class="r"><code># add 1d rectangleGate layer (no need for )
rect.g1d &lt;- rectangleGate(&quot;FSC-H&quot; =  c(550, Inf))
p1 + geom_hvline(data = rect.g1d, colour = &quot;red&quot;) # vline</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-3.png" width="672" /></p>
<pre class="r"><code>p1 + geom_hvline(data = rectangleGate(&quot;SSC-H&quot; = c(550, Inf)), colour = &quot;red&quot;) #hline</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-4.png" width="672" /></p>
<pre class="r"><code># n samples + 1 gate
myColor &lt;- rev(RColorBrewer::brewer.pal(11, &quot;Spectral&quot;))
myColor_scale_fill &lt;- scale_fill_gradientn(colours = myColor)
p &lt;- ggplot(fs, aes(x = `FSC-H`, y =  `SSC-H`)) + myColor_scale_fill + stat_binhex(bins = 64) + ylim(c(10,9e2)) + xlim(c(10,9e2)) + facet_wrap(~name)    
p + geom_path(data = lg, colour = &quot;red&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-5.png" width="672" /></p>
<pre class="r"><code># n samples + n gates
#fit lymphgate filter to multiple samples
lgs &lt;- lapply(1:length(fs), function(idx) flowStats::lymphGate(fs[[idx]], channels=c(&quot;FSC-H&quot;, &quot;SSC-H&quot;),scale=0.6))
names(lgs) &lt;- sampleNames(fs)

# add a list of gates as gate layer
# Note: pData must be explicitly attached to geom_gate layer for facetting
lgs &lt;- filterList(lgs)
attr(lgs, &quot;pd&quot;) &lt;- pData(fs)
p + geom_path(data = lgs, colour = &quot;red&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-6.png" width="672" /></p>
<pre class="r"><code># add stats
stats &lt;- compute_stats(fs, lgs, type = &quot;percent&quot;)# calculate cell % and ccentroid of the gates
p + geom_path(data = lgs, colour = &quot;red&quot;) + geom_label(data = stats , aes(label = value))</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-7.png" width="672" /></p>
<pre class="r"><code># a list of 1d gate
den.gates &lt;- fsApply(fs, openCyto::mindensity, channel = &quot;FSC-H&quot;, gate_range = c(100, 300), adjust = 1)
den.gates &lt;- filterList(den.gates)
attr(den.gates, &quot;pd&quot;) &lt;- pData(fs)
p + geom_hvline(data = den.gates, colour = &quot;red&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-8.png" width="672" /></p>
<pre class="r"><code># 1d gate on another dimesion
den.gates &lt;- fsApply(fs, openCyto::mindensity, channel = &quot;SSC-H&quot;, gate_range = c(100, 500), adjust = 1)
den.gates &lt;- filterList(den.gates)
attr(den.gates, &quot;pd&quot;) &lt;- pData(fs)

# add stats
# stats &lt;- compute_stats(fs, den.gates)# calculate cell % and ccentroid of the gates
# p + geom_hvline(data = den.gates, colour = &quot;red&quot;) + geom_label(data = stats , aes(label = value), fill = &quot;yellow&quot;)
p + geom_hvline(data = den.gates, colour = &quot;red&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-9.png" width="672" /></p>
<pre class="r"><code># 1d gate on density plot
p1 &lt;- ggplot(fs, aes(x = `SSC-H`)) + geom_density(aes(y = ..scaled..),fill = &quot;black&quot;) + facet_wrap(~name) 
p1 &lt;- p1 + geom_hvline(data = den.gates, colour = &quot;red&quot;) 
#must define y aes here since ggplot object does not have y defined in aes
# p1 + geom_label(data = stats , aes(label = value, y = density))
p1</code></pre>
<p><img src="docs/examples/ggcyto/ggplot.flowSet.gate_files/figure-html/unnamed-chunk-3-10.png" width="672" /></p>
