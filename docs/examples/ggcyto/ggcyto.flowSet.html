---
title: "Visualize flowSet with ggcyto"
output:
  html_document:
    fig_height: 3
    fig_width: 5
    keep_md: yes
    toc: yes
    toc_float: true
vignette: >    
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Visualize flowSet with ggcyto}
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<pre class="r"><code>library(ggcyto)
data(GvHD)
fs &lt;- GvHD[subset(pData(GvHD), Patient %in%5:7 &amp; Visit %in% c(5:6))[[&quot;name&quot;]]]
fr &lt;- fs[[1]]</code></pre>
<div id="d-histogramdensityplot" class="section level3">
<h3>1d histogram/densityplot</h3>
<p><code>ggcyto</code> wrapper will construct the <code>ggcyto</code> object that inherits from <code>ggplot</code> class.</p>
<pre class="r"><code>p &lt;- ggcyto(fs, aes(x = `FSC-H`)) 
class(p)</code></pre>
<pre><code>## [1] &quot;ggcyto_flowSet&quot;
## attr(,&quot;package&quot;)
## [1] &quot;ggcyto&quot;</code></pre>
<pre class="r"><code>is(p, &quot;ggplot&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>Since only one dimension is specified, we can add any 1d geom layer</p>
<pre class="r"><code>p1 &lt;- p + geom_histogram() 
p1</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>As shown, data is facetted by samples name automatically (i.e <code>facet_wrap(~name)</code>).</p>
<p>We can overwrite the default faceting by any variables that are defined in <code>pData</code></p>
<pre class="r"><code>pData(fs)</code></pre>
<pre><code>##       Patient Visit Days Grade  name
## s5a05       5     5   19     3 s5a05
## s5a06       5     6   26     3 s5a06
## s6a05       6     5   19     3 s6a05
## s6a06       6     6   27     3 s6a06
## s7a05       7     5   21     3 s7a05
## s7a06       7     6   28     3 s7a06</code></pre>
<pre class="r"><code>p1 + facet_grid(Patient~Visit)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>To display 1d density</p>
<pre class="r"><code>p + geom_density()</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Fill the same color</p>
<pre class="r"><code>p + geom_density(fill = &quot;black&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Fill different colors</p>
<pre class="r"><code>ggcyto(fs, aes(x = `FSC-H`, fill = name)) + geom_density(alpha = 0.2)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Or plot in the same panel by using <code>ggplot</code> directly (thus removing the default facetting effect)</p>
<pre class="r"><code>ggplot(fs, aes(x = `FSC-H`, fill = name)) + geom_density(alpha = 0.2)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="stacked-density-plot" class="section level3">
<h3>stacked density plot</h3>
<pre class="r"><code>#you can use ggridges package to display stacked density plot
require(ggridges)
#stack by fcs file (&#39;name&#39;)
p + geom_density_ridges(aes(y = name)) + facet_null() #facet_null is used to remove the default facet_wrap (by &#39;name&#39; column)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<pre class="r"><code>#or to stack by Visit and facet by patient
p + geom_density_ridges(aes(y = Visit)) + facet_grid(~Patient)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-10-2.png" width="672" /></p>
</div>
<div id="d-scatterdot-plot" class="section level3">
<h3>2d scatter/dot plot</h3>
<pre class="r"><code># 2d hex
p &lt;- ggcyto(fs, aes(x = `FSC-H`, y =  `SSC-H`))
p &lt;- p + geom_hex(bins = 128)
p</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>A default <code>scale_fill_gradientn</code> is applied to 2d hexbin plot.</p>
<p>To add limits</p>
<pre class="r"><code>p &lt;- p + ylim(c(10,9e2)) + xlim(c(10,9e2))   
p</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>To overwrite the default fill gradien</p>
<pre class="r"><code>p + scale_fill_gradientn(colours = rainbow(7), trans = &quot;sqrt&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<pre class="r"><code>p + scale_fill_gradient(trans = &quot;sqrt&quot;, low = &quot;gray&quot;, high = &quot;black&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-13-2.png" width="672" /></p>
</div>
<div id="add-geom_gate-and-geom_stats-layers" class="section level3">
<h3>Add <code>geom_gate</code> and <code>geom_stats</code> layers</h3>
<p>Firstly we create an <code>ellipsoidGate</code> with a data-driven method provided by <code>flowStats</code> package.</p>
<pre class="r"><code># estimate a lymphGate (which is an ellipsoidGate) for each sample
lg &lt;- flowStats::lymphGate(fs, channels=c(&quot;FSC-H&quot;, &quot;SSC-H&quot;),scale=0.6)
# apply the ellipsoidGates to their corresponding samples
fres &lt;- filter(fs, lg)</code></pre>
<p>Then pass the gates to the gate layer</p>
<pre class="r"><code>p + geom_gate(lg)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>We can also plot the <code>rectangleGate</code>, this time we simply replicate a static gate across samples:</p>
<pre class="r"><code>rect.g &lt;- rectangleGate(list(&quot;FSC-H&quot; =  c(300,500), &quot;SSC-H&quot; = c(50,200)))
rect.gates &lt;- sapply(sampleNames(fs), function(sn)rect.g)</code></pre>
<p>Similarly, supply the list of gates to the <code>geom_gate</code> layer</p>
<pre class="r"><code>p + geom_gate(rect.gates)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Stats layer can be added on top of gate</p>
<pre class="r"><code>p + geom_gate(rect.gates) + geom_stats(size = 3)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>The <code>percentage</code> of the gated population over its parent is displayed as <code>geom_label</code>. Alternatively cell <code>count</code> can be displayed by setting <code>type</code> argument in <code>geom_stats</code> function.</p>
<p>Here is another example of displaying the 1d gate generated by the automated gating method <code>gate_mindensity</code> from <code>openCyto</code> package.</p>
<pre class="r"><code>den.gates.x &lt;- fsApply(fs, openCyto::gate_mindensity, channel = &quot;FSC-H&quot;, gate_range = c(100, 300), adjust = 1)
p + geom_gate(den.gates.x) + geom_stats()</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p><code>geom_gate</code> layer supports the 1d gate on either dimension, which means it automatically determines between the vertical or horizontal lines based on the gate dimension and given <code>aes</code>.</p>
<pre class="r"><code>den.gates.y &lt;- fsApply(fs, openCyto::gate_mindensity, channel = &quot;SSC-H&quot;, gate_range = c(100, 500), adjust = 1, positive = FALSE)

p + geom_gate(den.gates.y) + geom_stats(value = lapply(rect.gates, function(g)0.1))</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Here we also demenstrated the option of passing the precalculated arbitary stats value to <code>geom_stats</code> lay instead of letting it compute on the fly,</p>
<p>We can also put the 1d gate on density plot</p>
<pre class="r"><code>ggcyto(fs, aes(x = `FSC-H`)) + geom_density(fill = &quot;black&quot;, aes(y = ..scaled..)) + geom_gate(den.gates.x)  + geom_stats(type = &quot;count&quot;)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>Without supplying <code>data</code> for <code>geom_stats</code>, we add stats layer for all the gate layers implicitly</p>
<pre class="r"><code>p + geom_gate(lg) + geom_gate(rect.gates) + geom_stats(size = 3)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Or we can add stats layer specificly just for one of the gate layer</p>
<pre class="r"><code>p + geom_gate(lg) + geom_gate(rect.gates) + geom_stats(gate = lg, size = 3)</code></pre>
<p><img src="docs/examples/ggcyto/ggcyto.flowSet_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>Although <code>ggcyto</code> object is fully ggplot-compatible in terms of adding layers and parameters, its data slot MAY NOT be fully fortified to data.frame before it is printed/plotted.</p>
<pre class="r"><code>class(p)</code></pre>
<pre><code>## [1] &quot;ggcyto_flowSet&quot;
## attr(,&quot;package&quot;)
## [1] &quot;ggcyto&quot;</code></pre>
<pre class="r"><code>class(p$data)</code></pre>
<pre><code>## [1] &quot;flowSet&quot;
## attr(,&quot;package&quot;)
## [1] &quot;flowCore&quot;</code></pre>
<p>To convert it to a pure ggplot object, use <code>as.ggplot</code> function:</p>
<pre class="r"><code>p &lt;- as.ggplot(p)

class(p)</code></pre>
<pre><code>## [1] &quot;gg&quot;     &quot;ggplot&quot;</code></pre>
<pre class="r"><code>class(p$data)</code></pre>
<pre><code>## [1] &quot;data.table&quot; &quot;data.frame&quot;</code></pre>
</div>
