---
title: "How to merge/standardize GatingSets"
output:
  html_document:
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
author: Greg Finak <gfinak@fhcrc.org>, Mike Jiang <wjiang2@fhcrc.org>
vignette: >    
  %\VignetteIndexEntry{How to merge GatingSets}
  %\VignetteEngine{knitr::rmarkdown}
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="how-to-mergestandardize-gatingsets" class="section level1">
<h1>How to merge/standardize GatingSets</h1>
<div id="usage" class="section level2">
<h2>Usage</h2>
<pre class="r"><code>gs_split_by_tree(x)
gs_check_redundant_nodes(x)
gs_remove_redundant_nodes(x,toRemove)
gs_remove_redundant_channels(gs, ...)</code></pre>
</div>
<div id="arguments" class="section level2">
<h2>Arguments</h2>
<p><strong>x</strong><br />
‘GatingSet’ objects or or list of groups (each group member is a list of ’GatingSet`)</p>
<p><strong>toRemove</strong>
list of the node sets to be removed. its length must equals to the length of argument <strong>x</strong></p>
<p><strong>…</strong> other arguments</p>
</div>
<div id="remove-the-redudant-leafterminal-nodes" class="section level2">
<h2>Remove the redudant leaf/terminal nodes</h2>
<p><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-3-1.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-3-2.png" width="384" /></p>
<p>Leaf nodes <strong>DNT</strong> and <strong>DPT</strong> are redudant for the analysis and should be <strong>removed</strong> before merging.</p>
</div>
<div id="hide-the-non-leaf-nodes" class="section level2">
<h2>Hide the non-leaf nodes</h2>
<p><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-4-1.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-4-2.png" width="384" /></p>
<p><strong>singlets</strong> node is not present in the second tree. But we <strong>can’t</strong> remove it because it will remove all its descendants. We can <strong>hide</strong> it instead.</p>
<pre class="r"><code>invisible(gs_pop_set_visibility(gs2, &quot;singlets&quot;, FALSE))
plot(gs2)
plot(gs3)</code></pre>
<p><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-5-1.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-5-2.png" width="384" /></p>
<p>Note that even gating trees look the same but <strong>singlets</strong> still physically exists so
we must refer the populations by <strong>relative path</strong> (<code>path = "auto"</code>) instead of <strong>full path</strong>.</p>
<pre class="r"><code>gs_get_pop_paths(gs2)[5]
gs_get_pop_paths(gs3)[5]</code></pre>
<pre><code>## [1] &quot;/not debris/singlets/CD3+/CD4/38- DR+&quot;
## [1] &quot;/not debris/CD3+/CD4/38- DR+&quot;</code></pre>
<pre class="r"><code>gs_get_pop_paths(gs2, path = &quot;auto&quot;)[5]
gs_get_pop_paths(gs3, path = &quot;auto&quot;)[5]</code></pre>
<pre><code>## [1] &quot;CD4/38- DR+&quot;
## [1] &quot;CD4/38- DR+&quot;</code></pre>
</div>
<div id="isomorphism" class="section level2">
<h2>Isomorphism</h2>
<p><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-9-1.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-9-2.png" width="384" /></p>
<p>These two trees are <strong>not identical</strong> due to the <strong>different order</strong> of <strong>CD4</strong> and <strong>CD8</strong>. However they are still mergable thanks to the <strong>reference by gating path</strong> instead of <code>by numeric indices</code></p>
</div>
<div id="convenient-wrapper-for-merging" class="section level2">
<h2>convenient wrapper for merging</h2>
<p>To ease the process of merging large number of batches of experiments, here is some <strong>internal wrappers</strong> to make it <strong>semi-automated</strong>.</p>
<div id="grouping-by-tree-structures" class="section level3">
<h3>Grouping by tree structures</h3>
<pre class="r"><code>gslist &lt;- list(gs1, gs2, gs3, gs4, gs5)
gs_groups &lt;- gs_split_by_tree(gslist)</code></pre>
<pre><code>## Grouping by Gating tree...</code></pre>
<pre class="r"><code>length(gs_groups)</code></pre>
<p>[1] 4</p>
<p>This divides all the <code>GatingSet</code>s into different groups, each group shares the same tree structure. Here we have <code>4</code> groups,
## Check if the discrepancy can be resolved by dropping leaf nodes</p>
<pre class="r"><code>res &lt;- try(gs_check_redundant_nodes(gs_groups), silent = TRUE)
print(res[[1]])</code></pre>
<p>[1] “Error in (function (thisNodeSet, thisObj) : Can’t drop the non-terminal nodes: singlets”</p>
<p>Apparently the non-leaf node (<code>singlets</code>) fails this check, and it is up to user to decide whether to hide this node or keep this group separate from further merging.Here we try to hide it.</p>
<pre class="r"><code>for(gp in gs_groups)
  plot(gp[[1]])</code></pre>
<p><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-12-1.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-12-2.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-12-3.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-12-4.png" width="384" /></p>
<p>Based on the tree structure of each group (usually there aren’t as many groups as <code>GatingSet</code> objects itself), we will hide <code>singlets</code> for <code>group 2</code> and <code>group 4</code>.</p>
<pre class="r"><code>for(i in c(2,4))
  for(gs in gs_groups[[i]])
    invisible(gs_pop_set_visibility(gs, &quot;singlets&quot;, FALSE))</code></pre>
<p>Now check again with <code>.gs_check_redundant_nodes</code></p>
<pre class="r"><code>toRm &lt;- gs_check_redundant_nodes(gs_groups)
toRm</code></pre>
<p>[[1]]
[1] “CCR7+ 45RA+” “CCR7+ 45RA-”</p>
<p>[[2]]
[1] “DNT” “DPT”</p>
<p>[[3]]
character(0)</p>
<p>[[4]]
character(0)</p>
<p>Based on this, these groups can be consolidated by dropping
* <code>CCR7+ 45RA+</code> and <code>CCR7+ 45RA-</code> from <code>group 1</code>.
* <code>DNT</code> and <code>DPT</code> from <code>group 2</code>.</p>
<p>Sometime it could be difficult to inspect and distinguish tree difference by simply plotting the enire gating tree or looking at this simple flat list of nodes (especially when the entire subtree is missing from cerntain groups). It is helpful to visualize and highlight only the tree hierarchy difference with the helper function <code>gs_plot_diff_tree</code></p>
<pre class="r"><code>gs_plot_diff_tree(gs_groups)</code></pre>
<p><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-15-1.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-15-2.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-15-3.png" width="384" /><img src="docs/examples/flowWorkspace/HowToMergeGatingSet_files/figure-html/unnamed-chunk-15-4.png" width="384" /></p>
<p>To proceed the deletion of these nodes, <code>.gs_remove_redundant_nodes</code> can be used instead of doing it manually</p>
<pre class="r"><code>gs_remove_redundant_nodes(gs_groups, toRm)</code></pre>
<pre><code>## Removing CCR7+ 45RA+</code></pre>
<pre><code>## Removing CCR7+ 45RA-</code></pre>
<pre><code>## Removing DNT</code></pre>
<pre><code>## Removing DPT</code></pre>
<p>Now they can be merged into a single <code>GatingSetList</code>.</p>
<pre class="r"><code>GatingSetList(gslist)</code></pre>
<pre><code>## Warning: &#39;GatingSetList&#39; is deprecated.
## Use &#39;merge_list_to_gs&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<p>An GatingSetList with 5 GatingSet
containing 5 unique samples.</p>
</div>
</div>
<div id="remove-the-redundant-channels-from-gatingset" class="section level2">
<h2>Remove the redundant channels from <code>GatingSet</code></h2>
<p>Sometime there may be the extra <code>channels</code> in one data set that prevents it from being merged with other. If these channels are not used by any gates, then they can be safely removed.</p>
<pre class="r"><code>gs_remove_redundant_channels(gs1)</code></pre>
<pre><code>## drop FSC-H, FSC-W, &lt;G560-A&gt;, &lt;G780-A&gt;, Time</code></pre>
<p>A GatingSet with 1 samples</p>
</div>
</div>
