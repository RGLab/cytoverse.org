---
title: "How to import Cytobank into a GatingSet"
author: "Mike Jiang"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: true
vignette: >    
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{How to import Cytobank into a GatingSet}
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>This vignette demonstrates how the gatingML files exported from Cytobank can be imported into R as a GatingSet object.</p>
<pre class="r"><code>library(flowWorkspace)
library(CytoML)
acs &lt;- system.file(&quot;extdata/cytobank_experiment.acs&quot;, package = &quot;CytoML&quot;)</code></pre>
<p>Create <code>cytobank_experiment</code> object from the ACS bundle exported from Cytobank</p>
<pre class="r"><code>ce &lt;- open_cytobank_experiment(acs)
ce</code></pre>
<pre><code>## cytobank Experiment:  tcell 
## gatingML File:  /tmp/RtmpYQJ7Tg/file41d172db4ef7/experiments/3637/cytobank_gate_ml2_v41.xml 
##     panel samples
## 1 Panel 1       1</code></pre>
<p><strong>cytobank_experiment</strong> is a wrapper around the <code>ACS</code> file, which can be inspected by various accessors.</p>
<pre class="r"><code>sampleNames(ce)</code></pre>
<pre><code>## [1] &quot;CytoTrol_CytoTrol_1.fcs&quot;</code></pre>
<pre class="r"><code>colnames(ce)</code></pre>
<pre><code>##  [1] &quot;FSC-A&quot;  &quot;FSC-H&quot;  &quot;FSC-W&quot;  &quot;SSC-A&quot;  &quot;B710-A&quot; &quot;R660-A&quot; &quot;R780-A&quot; &quot;V450-A&quot;
##  [9] &quot;V545-A&quot; &quot;G560-A&quot; &quot;G780-A&quot; &quot;Time&quot;</code></pre>
<pre class="r"><code>markernames(ce)</code></pre>
<pre><code>## $CytoTrol_CytoTrol_1.fcs
##  [1] &quot;FSC-A&quot;        &quot;FSC-H&quot;        &quot;FSC-W&quot;        &quot;SSC-A&quot;        &quot;CD4&quot;         
##  [6] &quot;CD38 APC&quot;     &quot;CD8 APCH7&quot;    &quot;CD3&quot;          &quot;HLA-DR V500&quot;  &quot;CCR7 PE&quot;     
## [11] &quot;CD45RA PECy7&quot; &quot;Time&quot;</code></pre>
<pre class="r"><code>pData(ce)</code></pre>
<pre><code>##                                            name Conditions Individuals
## CytoTrol_CytoTrol_1.fcs CytoTrol_CytoTrol_1.fcs condition1       ptid1</code></pre>
<p>Then import <code>cytobank_experiment</code> into <strong>GatingSet</strong></p>
<pre class="r"><code>gs &lt;- cytobank_to_gatingset(ce)</code></pre>
<p>Alternatively, the import can be done by <code>gatingML</code> and <code>fcs</code> files that are downloaded separately form Cytobank without <code>ACS</code>.</p>
<pre class="r"><code>xmlfile &lt;- ce$gatingML
fcsFiles &lt;- list.files(ce$fcsdir, full.names = TRUE)
gs &lt;- cytobank_to_gatingset(xmlfile, fcsFiles)</code></pre>
<p>However, it doesn’t have the information from <code>yaml</code> file (part of <code>ACS</code>). E.g. sample tags (i.e. <code>pData</code>) and customized markernames. So it is recommended to import <code>ACS</code>.</p>
<p>Inspect the results</p>
<pre class="r"><code>library(ggcyto)
## Plot the gates
autoplot(gs[[1]])</code></pre>
<p><img src="docs/examples/CytoML/cytobank2GatingSet_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<pre class="r"><code># Extract the population statistics
gs_pop_get_count_fast(gs, statType = &quot;count&quot;)</code></pre>
<pre><code>##                        name                                     Population
##  1: CytoTrol_CytoTrol_1.fcs                                    /not debris
##  2: CytoTrol_CytoTrol_1.fcs                           /not debris/singlets
##  3: CytoTrol_CytoTrol_1.fcs                       /not debris/singlets/CD3
##  4: CytoTrol_CytoTrol_1.fcs                   /not debris/singlets/CD3/CD8
##  5: CytoTrol_CytoTrol_1.fcs            /not debris/singlets/CD3/CD8/CD8_Q2
##  6: CytoTrol_CytoTrol_1.fcs                   /not debris/singlets/CD3/CD4
##  7: CytoTrol_CytoTrol_1.fcs                /not debris/singlets/CD3/CD4/Q1
##  8: CytoTrol_CytoTrol_1.fcs                /not debris/singlets/CD3/CD4/Q2
##  9: CytoTrol_CytoTrol_1.fcs                /not debris/singlets/CD3/CD4/Q4
## 10: CytoTrol_CytoTrol_1.fcs                /not debris/singlets/CD3/CD4/Q3
## 11: CytoTrol_CytoTrol_1.fcs /not debris/singlets/CD3/CD8/CD8_Q2/CD38 range
## 12: CytoTrol_CytoTrol_1.fcs  /not debris/singlets/CD3/CD8/CD8_Q2/HLA range
##                                  Parent Count ParentCount
##  1:                                root 87876      119531
##  2:                         /not debris 79845       87876
##  3:                /not debris/singlets 53135       79845
##  4:            /not debris/singlets/CD3 12862       53135
##  5:        /not debris/singlets/CD3/CD8  2331       12862
##  6:            /not debris/singlets/CD3 33653       53135
##  7:        /not debris/singlets/CD3/CD4   419       33653
##  8:        /not debris/singlets/CD3/CD4 11429       33653
##  9:        /not debris/singlets/CD3/CD4  4119       33653
## 10:        /not debris/singlets/CD3/CD4 17686       33653
## 11: /not debris/singlets/CD3/CD8/CD8_Q2  2331        2331
## 12: /not debris/singlets/CD3/CD8/CD8_Q2  2315        2331</code></pre>
