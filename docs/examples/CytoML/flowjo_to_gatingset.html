---
title: "Import FlowJo workspace to R"
author: "Mike Jiang"
date: "2020-10-15"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    collapsed: false
    number_sections: true
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="basics" class="section level1">
<h1>Basics</h1>
<p><code>CytoML</code> provides <code>flowjo_to_gatingset</code> function to parse <code>FlowJo</code> workspace (<code>xml</code> or <code>wsp</code> file) and FCS files into a self-contained <code>GatingSet</code> object, which captures the entire analysis recorded in flowJo, include <code>compensation</code>, <code>transformation</code> and <code>gating</code>.</p>
<div id="open-the-workspace" class="section level2">
<h2>open the workspace</h2>
<pre class="r"><code>library(CytoML)</code></pre>
<pre><code>## Warning: replacing previous import &#39;data.table:::=&#39; by &#39;ggplot2:::=&#39; when
## loading &#39;ggcyto&#39;</code></pre>
<pre class="r"><code>dataDir &lt;- system.file(&quot;extdata&quot;,package=&quot;flowWorkspaceData&quot;)
wsfile &lt;- list.files(dataDir, pattern=&quot;manual.xml&quot;,full=TRUE)
ws &lt;- open_flowjo_xml(wsfile)
ws</code></pre>
<pre><code>## File location:  /usr/local/lib/R/cytoset/flowWorkspaceData/extdata/manual.xml 
## 
## Groups in Workspace
##          Name Num.Samples
## 1 All Samples          45
## 2      B-cell           4
## 3          DC           4
## 4      T-cell           4
## 5     Thelper           4
## 6        Treg           4</code></pre>
<div id="extract-groups-from-xml" class="section level3">
<h3>Extract groups from xml</h3>
<p>Once opened, sample group information can be retrieved</p>
<pre class="r"><code>tail(fj_ws_get_sample_groups(ws))</code></pre>
<pre><code>##    groupName groupID sampleID
## 60   Thelper       4       30
## 61   Thelper       4       31
## 62      Treg       5       37
## 63      Treg       5       38
## 64      Treg       5       39
## 65      Treg       5       40</code></pre>
</div>
<div id="extract-samples-from-xml" class="section level3">
<h3>Extract Samples from xml</h3>
<p>And sample information for a given group</p>
<pre class="r"><code>fj_ws_get_samples(ws, group_id = 5)</code></pre>
<pre><code>##   sampleID                    name  count pop.counts
## 1       28 CytoTrol_CytoTrol_1.fcs 136304         23
## 2       29 CytoTrol_CytoTrol_2.fcs 115827         23
## 3       30 CytoTrol_CytoTrol_3.fcs 123170         23
## 4       31 CytoTrol_CytoTrol_4.fcs 114802         23</code></pre>
</div>
<div id="extract-keywords-from-xml" class="section level3">
<h3>Extract keywords from xml</h3>
<p>keywords recorded in xml for a given sample</p>
<pre class="r"><code>fj_ws_get_keywords(ws, 28)[1:5]</code></pre>
<pre><code>## $`$BEGINANALYSIS`
## [1] &quot;0&quot;
## 
## $`$BEGINDATA`
## [1] &quot;3241&quot;
## 
## $`$BEGINSTEXT`
## [1] &quot;0&quot;
## 
## $`$BTIM`
## [1] &quot;13:28:46&quot;
## 
## $`$BYTEORD`
## [1] &quot;4,3,2,1&quot;</code></pre>
</div>
</div>
<div id="parse-with-default-settings" class="section level2">
<h2>Parse with default settings</h2>
<p>In majority use cases, only two parameters are required to complete the parsing, i.e.</p>
<ul>
<li><code>name</code>: the group to import</li>
<li><code>path</code>: the data path of FCS files.</li>
</ul>
<div id="select-group" class="section level3">
<h3>select group</h3>
<p><code>name</code> parameter can be set to the group name displayed above through <code>flowJo_workspace</code> APIs.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = &quot;T-cell&quot;)</code></pre>
<p><code>name</code> can also be the numeric index</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4)</code></pre>
</div>
<div id="fcs-path" class="section level3">
<h3>FCS path</h3>
<p>As shown above, the <code>path</code> be omitted if fcs files are located at the same folder as xml file.</p>
<div id="string" class="section level4">
<h4>string</h4>
<p>Otherwise, <code>path</code> is set the actual folder where FCS files are located. The folder can contain sub-folders and the parser will recursively look up the directory for FCS files (by matching the file names, keywords, etc)</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, path = dataDir)</code></pre>
</div>
<div id="data.frame" class="section level4">
<h4>data.frame</h4>
<p><code>path</code> can alternatively be a , which should contain two columns:‘sampleID’ and ‘file’. It essentially provides hardcoded mapping between ‘sampleID’ and FCS file (absolute) path to avoid the file system searching or sample matching process (between the flowJo sample reference and the FCS files).</p>
<p>However this is rarely needed since auto-searching does pretty accurate and robust matching.</p>
</div>
</div>
</div>
</div>
<div id="advanced" class="section level1">
<h1>Advanced</h1>
<p>Due to the varieties of FlowJo workspace or FCS file issues, sometime the default setting won’t be sufficient to handle some edge cases, e.g. when the error occurs at specific gate due to the incorrect gate parameters defined in xml , but we want to be able to import the upstream gates that are still useful. Or there is letter case inconsistency for channels used in xml, which will trigger an error by default.</p>
<p>Also there are other features provided by the parser that allow users to speed up the parsing or extract more meta data from either xml or FCS files.</p>
<p><code>flowjo_to_gatingset</code> provides more parameters that can be configured to solve different problems during the parsing. In document aims to go through these parameters and explore them one by one.</p>
<div id="parsing-xml-without-loading-fcs" class="section level2">
<h2>Parsing xml without loading FCS</h2>
<p>It is possible to only import the gating structure without reading the FCS data by setting <code>execute</code> flag to <code>FALSE</code>.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE)
gs</code></pre>
<pre><code>## A GatingSet with 4 samples</code></pre>
<p>Gating hierarchy is immediately available</p>
<pre class="r"><code>suppressMessages(library(flowWorkspace))
plot(gs)</code></pre>
<p><img src="docs/examples/CytoML/flowjo_to_gatingset_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>So are the gates</p>
<pre class="r"><code>gs_pop_get_gate(gs, &quot;CD3+&quot;)</code></pre>
<pre><code>## $CytoTrol_CytoTrol_1.fcs_119531
## Ellipsoid gate &#39;CD3+&#39; in dimensions &lt;V450-A&gt; and SSC-A
## 
## $CytoTrol_CytoTrol_2.fcs_115728
## Ellipsoid gate &#39;CD3+&#39; in dimensions &lt;V450-A&gt; and SSC-A
## 
## $CytoTrol_CytoTrol_3.fcs_113883
## Ellipsoid gate &#39;CD3+&#39; in dimensions &lt;V450-A&gt; and SSC-A
## 
## $CytoTrol_CytoTrol_4.fcs_110898
## Ellipsoid gate &#39;CD3+&#39; in dimensions &lt;V450-A&gt; and SSC-A</code></pre>
<p>compensations</p>
<pre class="r"><code>gs_get_compensations(gs)[1]</code></pre>
<pre><code>## $CytoTrol_CytoTrol_1.fcs_119531
## Compensation object &#39;defaultCompensation&#39;:
##          B710-A    G560-A    G780-A     R660-A    R780-A   V450-A   V545-A
## B710-A 1.000000 0.0009476  0.071170  0.0362400 0.1800000 0.007104 0.007608
## G560-A 0.115400 1.0000000  0.009097  0.0018360 0.0000000 0.000000 0.000000
## G780-A 0.014280 0.0380000  1.000000  0.0006481 0.1500000 0.000000 0.000000
## R660-A 0.005621 0.0000000  0.006604  1.0000000 0.1786000 0.000000 0.000000
## R780-A 0.000000 0.0000000  0.035340  0.0102100 1.0000000 0.000000 0.000000
## V450-A 0.000000 0.0000000 -0.060000 -0.0400000 0.0000000 1.000000 0.410000
## V545-A 0.002749 0.0000000  0.000000  0.0000000 0.0006963 0.035000 1.000000</code></pre>
<p>transformations</p>
<pre class="r"><code>gh_get_transformations(gs[[1]], channel = &quot;B710-A&quot;)</code></pre>
<pre><code>## function (x, deriv = 0)
##   {
##     deriv &lt;- as.integer(deriv)
##     if (deriv &lt; 0 || deriv &gt; 3)
##       stop(&quot;&#39;deriv&#39; must be between 0 and 3&quot;)
##     if (deriv &gt; 0) {
##       z0 &lt;- double(z$n)
##       z[c(&quot;y&quot;, &quot;b&quot;, &quot;c&quot;)] &lt;- switch(deriv, list(y = z$b, b = 2 *
##                   z$c, c = 3 * z$d), list(y = 2 * z$c, b = 6 * z$d,
##               c = z0), list(y = 6 * z$d, b = z0, c = z0))
##       z[[&quot;d&quot;]] &lt;- z0
##     }
## 
##     res &lt;- stats::: .splinefun(x,z)
##     if (deriv &gt; 0 &amp;&amp; z$method == 2 &amp;&amp; any(ind &lt;- x &lt;= z$x[1L]))
##       res[ind] &lt;- ifelse(deriv == 1, z$y[1L], 0)
##     res
##   }
## &lt;bytecode: 0x56278ddaa598&gt;
## &lt;environment: 0x56278ddc4ae8&gt;
## attr(,&quot;type&quot;)
## [1] &quot;biexp&quot;
## attr(,&quot;parameters&quot;)
## attr(,&quot;parameters&quot;)$channelRange
## [1] 4096
## 
## attr(,&quot;parameters&quot;)$maxValue
## [1] 261589.9
## 
## attr(,&quot;parameters&quot;)$neg
## [1] 0
## 
## attr(,&quot;parameters&quot;)$pos
## [1] 4.5
## 
## attr(,&quot;parameters&quot;)$widthBasis
## [1] -10</code></pre>
<p>and <code>stats</code></p>
<pre class="r"><code>head(gs_pop_get_stats(gs, xml = TRUE))</code></pre>
<pre><code>##                            sample                                   pop  count
## 1: CytoTrol_CytoTrol_1.fcs_119531                                  root 119531
## 2: CytoTrol_CytoTrol_1.fcs_119531                           /not debris  91720
## 3: CytoTrol_CytoTrol_1.fcs_119531                  /not debris/singlets  87033
## 4: CytoTrol_CytoTrol_1.fcs_119531             /not debris/singlets/CD3+  54737
## 5: CytoTrol_CytoTrol_1.fcs_119531         /not debris/singlets/CD3+/CD4  34083
## 6: CytoTrol_CytoTrol_1.fcs_119531 /not debris/singlets/CD3+/CD4/38- DR+   1124</code></pre>
<p>Note that <code>xml</code> flag needs to be set in order to tell it to return the stats from xml file. Otherwise it will display the value computed from FCS file, which will be <code>NA</code> in this case since we didn’t load FCS files.</p>
<p>Apparently, it is very fast to only import xml, but data won’t be available for retrieving.</p>
<pre class="r"><code>gs_pop_get_data(gs)</code></pre>
<pre><code>## Error in get_cytoset_from_node(obj@pointer, y): gate is not parsed!</code></pre>
</div>
<div id="additional-keys-to-tag-samples" class="section level2">
<h2>Additional keys to tag samples</h2>
<p>As shown above, the sample names appear to be the FCS filename appended with some numbers by default</p>
<pre class="r"><code>sampleNames(gs)</code></pre>
<pre><code>## [1] &quot;CytoTrol_CytoTrol_1.fcs_119531&quot; &quot;CytoTrol_CytoTrol_2.fcs_115728&quot;
## [3] &quot;CytoTrol_CytoTrol_3.fcs_113883&quot; &quot;CytoTrol_CytoTrol_4.fcs_110898&quot;</code></pre>
<p>These numbers are actually the value of <code>$TOT</code> keyword, which is the total number of events for each sample. This value is typically unique for each file thus is used to tag the sample on top of the existing sample name.
This default behavior is recommended so that samples can be uniquely identified even when duplication of file names occur, which is not uncommon. e.g. We often see the multiple files are named as <code>Specimen_XXX</code> that are located under different sub-folders.</p>
<div id="additional.keys" class="section level3">
<h3>additional.keys</h3>
<p>However, if users decide it is unnecessary in their case and prefer to the shorter names. It can be removed through <code>additional.keys</code> parameter</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.keys = NULL)
sampleNames(gs)</code></pre>
<pre><code>## [1] &quot;CytoTrol_CytoTrol_1.fcs&quot; &quot;CytoTrol_CytoTrol_2.fcs&quot;
## [3] &quot;CytoTrol_CytoTrol_3.fcs&quot; &quot;CytoTrol_CytoTrol_4.fcs&quot;</code></pre>
<p>Or it can be tagged by some extra keywords value if <code>$TOT</code> turns out to be not sufficient for the unique ID, which rarely happens.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.keys = c(&quot;$TOT&quot;, &quot;EXPERIMENT NAME&quot;))
sampleNames(gs)</code></pre>
<pre><code>## [1] &quot;CytoTrol_CytoTrol_1.fcs_119531_C2_Tcell&quot;
## [2] &quot;CytoTrol_CytoTrol_2.fcs_115728_C2_Tcell&quot;
## [3] &quot;CytoTrol_CytoTrol_3.fcs_113883_C2_Tcell&quot;
## [4] &quot;CytoTrol_CytoTrol_4.fcs_110898_C2_Tcell&quot;</code></pre>
</div>
<div id="additional.sampleid" class="section level3">
<h3>additional.sampleID</h3>
<p>And we can even include the <code>sample ID</code> used by flowJo xml when the filename and other keywords can’t be differentiated between samples. This can be turned on by <code>additional.sampleID</code> flag</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.sampleID = TRUE)
sampleNames(gs)</code></pre>
<pre><code>## [1] &quot;CytoTrol_CytoTrol_1.fcs_19_119531&quot; &quot;CytoTrol_CytoTrol_2.fcs_20_115728&quot;
## [3] &quot;CytoTrol_CytoTrol_3.fcs_21_113883&quot; &quot;CytoTrol_CytoTrol_4.fcs_22_110898&quot;</code></pre>
</div>
</div>
<div id="annotate-sample-with-keywords" class="section level2">
<h2>Annotate sample with keywords</h2>
<p>Be default, the pheno data of samples (returned by <code>pData()</code>) only contains single column of file name.</p>
<pre class="r"><code>pData(gs)</code></pre>
<pre><code>##                                                      name
## CytoTrol_CytoTrol_1.fcs_19_119531 CytoTrol_CytoTrol_1.fcs
## CytoTrol_CytoTrol_2.fcs_20_115728 CytoTrol_CytoTrol_2.fcs
## CytoTrol_CytoTrol_3.fcs_21_113883 CytoTrol_CytoTrol_3.fcs
## CytoTrol_CytoTrol_4.fcs_22_110898 CytoTrol_CytoTrol_4.fcs</code></pre>
<div id="keywords" class="section level3">
<h3>keywords</h3>
<p><code>keywords</code> can be specified to ask the parser to exact the keywords and attach them to the pdata.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.keys = NULL, keywords = c(&quot;EXPERIMENT NAME&quot;, &quot;TUBE NAME&quot;))
pData(gs)</code></pre>
<pre><code>##                                            name EXPERIMENT NAME  TUBE NAME
## CytoTrol_CytoTrol_1.fcs CytoTrol_CytoTrol_1.fcs        C2_Tcell CytoTrol_1
## CytoTrol_CytoTrol_2.fcs CytoTrol_CytoTrol_2.fcs        C2_Tcell CytoTrol_2
## CytoTrol_CytoTrol_3.fcs CytoTrol_CytoTrol_3.fcs        C2_Tcell CytoTrol_3
## CytoTrol_CytoTrol_4.fcs CytoTrol_CytoTrol_4.fcs        C2_Tcell CytoTrol_4</code></pre>
</div>
<div id="keywords.source" class="section level3">
<h3>keywords.source</h3>
<p>By default, <code>keywords</code> are parsed from xml file. Alternatively it can be read from FCS files by setting <code>keywords.source = "FCS"</code>.
Obviously, <code>execute</code> needs to be set to <code>TRUE</code> in order for this to succeed.</p>
</div>
<div id="keyword.ignore.case" class="section level3">
<h3>keyword.ignore.case</h3>
<p>Occasionally, keyword names may not be case consistent across samples, e.g. <code>tube name</code> vs <code>TUBE NAME</code>, which will prevent the parser from
constructing the <code>pData</code> data structure properly.</p>
<p><code>keyword.ignore.case</code> can be optionally set to <code>TRUE</code> in order to relax the rule to make the parser succeed.
But it is recommended to keep it as default (especially when <code>keywords.source = "FCS"</code>) and use the dedicated tool <code>cytoqc</code> package to standardize <code>FCS</code> files before running the parser.</p>
</div>
</div>
<div id="import-a-subset" class="section level2">
<h2>Import a subset</h2>
<p>Sometime it is useful to only select a small subset of samples to import to quickly test or review the content of gating tree instead of waiting for the entire data set to be completed, which could take longer time if the total number of samples is big.</p>
<p><code>subset</code> argument takes numeric indies, e.g.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.keys = NULL, subset = 1:2)
sampleNames(gs)</code></pre>
<pre><code>## [1] &quot;CytoTrol_CytoTrol_1.fcs&quot; &quot;CytoTrol_CytoTrol_2.fcs&quot;</code></pre>
<p>or the vector of sample (FCS) names, e.g.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.keys = NULL, subset = c(&quot;CytoTrol_CytoTrol_3.fcs&quot;))
sampleNames(gs)</code></pre>
<p>or an  that is similar to the one passed to ‘base::subset’ function to filter a data.frame.
Note that the columns referred by the expression must also be explicitly specified in ‘keywords’ argument, which we will cover in the later sections.</p>
<p>e.g.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, execute = FALSE, additional.keys = NULL
                                                        , subset = `EXPERIMENT NAME` == &quot;C2_Tcell&quot;
                                                        , keywords = c(&quot;EXPERIMENT NAME&quot;)
                                                        )

pData(gs)</code></pre>
<pre><code>##                                            name EXPERIMENT NAME
## CytoTrol_CytoTrol_1.fcs CytoTrol_CytoTrol_1.fcs        C2_Tcell
## CytoTrol_CytoTrol_2.fcs CytoTrol_CytoTrol_2.fcs        C2_Tcell
## CytoTrol_CytoTrol_3.fcs CytoTrol_CytoTrol_3.fcs        C2_Tcell
## CytoTrol_CytoTrol_4.fcs CytoTrol_CytoTrol_4.fcs        C2_Tcell</code></pre>
</div>
<div id="parallel-parsing" class="section level2">
<h2>Parallel parsing</h2>
<p>It is possible to utilize multiple cpus (cores) to speed up the parsing where each sample is parsed and gated concurrently.
Parallel parsing is enabled when <code>mc.cores</code> is set to the value &gt; 1.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, mc.cores = 4)</code></pre>
<p>However, be careful to avoid setting too many cores, which may end up slowing down the process caused by disk IO because FCS files need to be read from disk and the type of file system also contributes to the performance. e.g. parallel file system provided by HPC usually performs better than the regular personal computer.</p>
</div>
<div id="skip-leaf-boolean-gates" class="section level2">
<h2>Skip leaf boolean gates</h2>
<p>Sometime the gating tree could be big and could be slow to import all the gates, e.g.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name=&quot;Samples&quot;, subset = &quot;1379326.fcs&quot;, execute = FALSE)
nodes &lt;- gs_get_pop_paths(gs)
length(nodes)</code></pre>
<pre><code>## [1] 235</code></pre>
<pre class="r"><code>plot(gs, &quot;3+&quot;)</code></pre>
<p><img src="docs/examples/CytoML/flowjo_to_gatingset_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>it contains a lot of boolean gates at the bottom level of the tree, e.g.</p>
<pre class="r"><code>tail(nodes, 10)</code></pre>
<pre><code>##  [1] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/IFNg+IL2+&quot;
##  [2] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/IFNg\\IL2&quot;
##  [3] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/IL2+&quot;     
##  [4] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/IL4+&quot;     
##  [5] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/IL13+&quot;    
##  [6] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/IL21+&quot;    
##  [7] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/PD1+&quot;     
##  [8] &quot;/S/Exclude/14-/Lv/L/3-/CD56+/TNFa+&quot;    
##  [9] &quot;/S/Exclude/14-/Lv/L/Not CD4&quot;           
## [10] &quot;/S/Exclude/14-/Lv/L/Not CD8&quot;</code></pre>
<p>If these boolean gates are not important for the analysis, user can choose to skip computing them</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name=&quot;Samples&quot;, subset = &quot;1379326.fcs&quot;, leaf.bool = F)
gs_pop_get_stats(gs)</code></pre>
<pre><code>##                  sample                                pop  count
##   1: 1379326.fcs_262418                               root 262418
##   2: 1379326.fcs_262418                                 /S 256010
##   3: 1379326.fcs_262418                         /S/Exclude 255426
##   4: 1379326.fcs_262418                     /S/Exclude/14- 197296
##   5: 1379326.fcs_262418                  /S/Exclude/14-/Lv 143660
##  ---                                                             
## 231: 1379326.fcs_262418 /S/Exclude/14-/Lv/L/3-/CD56+/IL21+      1
## 232: 1379326.fcs_262418  /S/Exclude/14-/Lv/L/3-/CD56+/PD1+     23
## 233: 1379326.fcs_262418 /S/Exclude/14-/Lv/L/3-/CD56+/TNFa+      1
## 234: 1379326.fcs_262418        /S/Exclude/14-/Lv/L/Not CD4     NA
## 235: 1379326.fcs_262418        /S/Exclude/14-/Lv/L/Not CD8     NA</code></pre>
<p>As shown, these boolean leaf gates are still imported, but not gated or computed (which is why stats are NA for these gates). This will speed up the parsing by avoid calculating significant portion of the tree.
And it can be computed later if user decides to do so</p>
<pre class="r"><code>recompute(gs)</code></pre>
<pre><code>## done!</code></pre>
<pre class="r"><code>gs_pop_get_stats(gs)</code></pre>
<pre><code>##                  sample                                pop  count
##   1: 1379326.fcs_262418                               root 262418
##   2: 1379326.fcs_262418                                 /S 256010
##   3: 1379326.fcs_262418                         /S/Exclude 255426
##   4: 1379326.fcs_262418                     /S/Exclude/14- 197296
##   5: 1379326.fcs_262418                  /S/Exclude/14-/Lv 143660
##  ---                                                             
## 231: 1379326.fcs_262418 /S/Exclude/14-/Lv/L/3-/CD56+/IL21+      1
## 232: 1379326.fcs_262418  /S/Exclude/14-/Lv/L/3-/CD56+/PD1+     23
## 233: 1379326.fcs_262418 /S/Exclude/14-/Lv/L/3-/CD56+/TNFa+      1
## 234: 1379326.fcs_262418        /S/Exclude/14-/Lv/L/Not CD4  58097
## 235: 1379326.fcs_262418        /S/Exclude/14-/Lv/L/Not CD8  75895</code></pre>
</div>
<div id="skip-faulty-gates" class="section level2">
<h2>Skip faulty gates</h2>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, path = dataDir, subset = 1)</code></pre>
<pre><code>## Error in (function (ws, group_id, subset, execute, path, cytoset, backend_dir, : colname not found: &lt;wrong-A&gt;</code></pre>
<p>This parsing error is due to the incorrect channel name is used by <code>CD4</code> gate that is defined in flowJo and FCS files don’t have that channel</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, path = dataDir, execute = FALSE)
plot(gs)</code></pre>
<p><img src="docs/examples/CytoML/flowjo_to_gatingset_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<pre class="r"><code>gs_pop_get_gate(gs, &quot;CD4&quot;)[[1]]</code></pre>
<pre><code>## Ellipsoid gate &#39;CD4&#39; in dimensions &lt;wrong-A&gt; and &lt;R780-A&gt;</code></pre>
<p>The parser can be told to skip <code>CD4</code> and all its descendants so that the rest of gates can still be parsed</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 4, path = dataDir, subset = 1, skip_faulty_gate = TRUE)</code></pre>
<pre><code>## colname not found: &lt;wrong-A&gt;
##  Skipping the faulty node &#39;CD4&#39; and its descendants</code></pre>
<pre class="r"><code>head(gs_pop_get_stats(gs))</code></pre>
<pre><code>##                            sample                                   pop  count
## 1: CytoTrol_CytoTrol_1.fcs_119531                                  root 119531
## 2: CytoTrol_CytoTrol_1.fcs_119531                           /not debris  91720
## 3: CytoTrol_CytoTrol_1.fcs_119531                  /not debris/singlets  87022
## 4: CytoTrol_CytoTrol_1.fcs_119531             /not debris/singlets/CD3+  54483
## 5: CytoTrol_CytoTrol_1.fcs_119531         /not debris/singlets/CD3+/CD4     NA
## 6: CytoTrol_CytoTrol_1.fcs_119531 /not debris/singlets/CD3+/CD4/38- DR+     NA</code></pre>
<p>Similar to skipping leaf boolean gates, faulty gates are still imported, but they are not computed.</p>
</div>
<div id="import-the-empty-gating-tree" class="section level2">
<h2>Import the empty gating tree</h2>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 1, path = dataDir)</code></pre>
<pre><code>## Error in (function (ws, group_id, subset, execute, path, cytoset, backend_dir, : No samples in this workspace to parse!</code></pre>
<p>This parsing error is actually due to the fact that the flowJo workspace doesn’t have any gates defined.
We can see that through</p>
<pre class="r"><code>fj_ws_get_samples(ws)</code></pre>
<pre><code>##   sampleID                    name  count pop.counts
## 1        1 CytoTrol_CytoTrol_1.fcs 119531          0</code></pre>
<p>By default, parser will ignore and skip any sample that has zero <code>population</code>s (consider them as invalid entries in xml). This is why it gives the message of no samples to parse.</p>
<p>User can choose to import it anyway (so that he can get FCS files to be compensated and transformed by flowJo xml),</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 1, path = dataDir, include_empty_tree = TRUE)
range(gs_cyto_data(gs)[[1]])</code></pre>
<pre><code>##      FSC-A  FSC-H  FSC-W  SSC-A Comp-B710-A Comp-R660-A Comp-R780-A Comp-V450-A
## min      0      0      0      0    50.70029    50.70029    50.70029    50.70029
## max 262143 262143 262143 262143   256.91464   256.91464   256.91464   256.91464
##     Comp-V545-A Comp-G560-A Comp-G780-A    Time
## min    50.70029    50.70029    50.70029    0.00
## max   256.91464   256.91464   256.91464 2621.43</code></pre>
</div>
<div id="customized-fc-file-extension" class="section level2">
<h2>Customized fc file extension</h2>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 1, path = dataDir, additional.keys = NULL)</code></pre>
<pre><code>## FCS not found for sample 0877408774.B08 from searching the file extension: .fcs</code></pre>
<pre><code>## Error in (function (ws, group_id, subset, execute, path, cytoset, backend_dir, : No samples in this workspace to parse!</code></pre>
<p>As the error message indicates, FCS file has the non-conventional extention <code>.B08</code> other than <code>.fcs</code>.
Parser can be configured to search for the customized fcs files.</p>
<pre class="r"><code>gs &lt;- flowjo_to_gatingset(ws, name = 1, path = dataDir, additional.keys = NULL, fcs_file_extension = &quot;.B08&quot;)
sampleNames(gs)</code></pre>
<pre><code>## [1] &quot;0877408774.B08&quot;</code></pre>
</div>
</div>
