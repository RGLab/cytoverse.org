---
title: "How to export a GatingSet to GatingML"
author: "Mike Jiang"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: true
vignette: >    
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{How to export a GatingSet to GatingML}
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>A <code>GatingSet</code> object can be exported as a GatingML file or GatingML-based wsp flowJo workspace (version 10) so that they can be loaded into <code>Cytobank</code> or <code>flowJo</code>.</p>
<p>The <code>GatingSet</code> to be exported can be either parsed from <code>Cytobank</code> or <code>flowJo</code> or created by automated gating
algorithms from <code>openCtyo</code>. Here we will demontrate the latter.</p>
<div id="automated-gating" class="section level2">
<h2>Automated gating</h2>
<div id="load-raw-fcs-files-into-gatingset" class="section level3">
<h3>Load raw FCS files into GatingSet</h3>
<pre class="r"><code>library(ncdfFlow)
library(flowWorkspace)
library(CytoML)
dataDir &lt;- system.file(&quot;extdata&quot;,package=&quot;flowWorkspaceData&quot;)
#load raw FCS
fs &lt;- load_cytoset_from_fcs(file.path(dataDir,&quot;CytoTrol_CytoTrol_1.fcs&quot;))
gs &lt;- GatingSet(fs)</code></pre>
</div>
<div id="compensate-and-transform" class="section level3">
<h3>Compensate and transform</h3>
<pre class="r"><code>#compensate
comp &lt;- spillover(fs[[1]])[[&quot;SPILL&quot;]]
chnls &lt;- colnames(comp)
comp &lt;- compensation(comp)
gs &lt;- compensate(gs, comp)

#transform
trans &lt;- flowjo_biexp_trans()
trans &lt;- transformerList(chnls, trans)
gs &lt;- transform(gs, trans)</code></pre>
<p>Note that the compensation and transformation <strong>must</strong> be applied directly to <code>GatingSet</code> instead of <code>flowSet/ncdfFlowSet</code> so that these information will be stored in the <code>GatingSet</code> object and exported to gatingML eventually.</p>
</div>
<div id="load-the-gating-template-and-run-auto-gating" class="section level3">
<h3>Load the gating template and run auto gating</h3>
<pre class="r"><code>library(openCyto)
#load the original template for tcell panel
tbl &lt;- data.table::fread(system.file(&quot;extdata/gating_template/tcell.csv&quot;, package = &quot;openCyto&quot;))
#modify some paramters to fit the current data range
tbl[5, gating_args:= &quot;gate_range = c(1e3, 3e3)&quot;]
tbl[c(8,11), gating_args:= &quot;gate_range = c(2e3, 3e3)&quot;]
#write the new template to disc
gtFile &lt;- tempfile()
write.csv(tbl, file = gtFile)
##reload the new template
gt &lt;- gatingTemplate(gtFile, autostart = 1L)
#run the gating
gating(gt, gs)
#hide the gates that are not of interest
toggle.helperGates(gt, gs)
#visualize the gates
library(ggcyto)
autoplot(gs[[1]])</code></pre>
<p><img src="docs/examples/CytoML/HowToExportGatingSet_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
</div>
<div id="export-to-cytobank" class="section level2">
<h2>Export to Cytobank</h2>
<pre class="r"><code>outFile &lt;- tempfile(fileext = &quot;.xml&quot;)
gatingset_to_cytobank(gs, outFile)</code></pre>
<pre><code>## [1] &quot;/tmp/RtmpfydBtG/file199966a1f371.xml&quot;</code></pre>
<p>Note that the resulted <code>xml</code> file is a standard <code>GatingML2.0</code> file with some additional <code>custom_info</code> added so that it can be recognized by <code>Cytobank</code>. Here is the example gate plot from <code>Cytobank</code> after the gatingML is imported.
<img src="cytobank.png" alt="Gates in Cytobank" /></p>
</div>
<div id="export-to-flowjo" class="section level2">
<h2>Export to FlowJo</h2>
<pre class="r"><code>outFile &lt;- tempfile(fileext = &quot;.wsp&quot;)
gatingset_to_flowjo(gs, outFile)</code></pre>
<p>The resutled <code>wsp</code> file is a <code>XML</code>-based <code>flowJo</code> workspace and can be loaded into <code>flowJo</code>(V10) along with orginal FCS files.Here is the gate plots from <code>flowJo</code> after it is imported.
<img src="flowJo.png" alt="Gates in flowJo" /></p>
</div>
